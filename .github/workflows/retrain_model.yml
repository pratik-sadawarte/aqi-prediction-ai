name: Weekly ML Model Retraining

on:
  schedule:
    # Every Sunday at 3:00 AM IST (21:30 UTC Saturday)
    - cron: "30 21 * * 6"

  workflow_dispatch:

jobs:
  retrain:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      # 3️⃣ Install dependencies
      - name: Install Dependencies
        run: |
          pip install pandas scikit-learn joblib

      # 4️⃣ Verify dataset exists
      - name: Verify Dataset
        run: |
          if [ ! -f "data/mumbai_aqi_weather.csv" ]; then
            echo "Dataset not found!"
            exit 1
          fi

      # 5️⃣ Retrain Model
      - name: Train ML Model
        run: |
          python src/train_pm25_model.py

      # 6️⃣ Commit updated model if changed
      - name: Commit Updated Model
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add models/
          git diff --quiet && git diff --staged --quiet || git commit -m "Auto-retrained PM2.5 model"

      # 7️⃣ Push changes
      - name: Push Changes
        run: |
          git push
